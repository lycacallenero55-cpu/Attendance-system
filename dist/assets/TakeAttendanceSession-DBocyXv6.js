import{c as H,h as ae,d as re,r as i,j as e,k as ie,s as ne,e as k}from"./index-UN-xnaxC.js";import{B as j}from"./index-BHXN4u0M.js";import{C as R,a as F,b as B,c as L}from"./card-CBRuYr9b.js";import{B as ce}from"./badge-CJDHipBu.js";import{L as V,U as oe}from"./Layout-8fUh4t3a.js";import{a as le}from"./aiService-D2eevCfb.js";import{C as z}from"./circle-x-DykbQ03L.js";import{L as X}from"./loader-circle-DlTFvp4H.js";import{S as de}from"./square-ic6ysHhU.js";import{R as me}from"./refresh-cw-Bjjpgvz4.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=H("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=H("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=H("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]),Me=()=>{const{sessionId:N}=ae(),Y=re(),[u,K]=i.useState(null),[Q,P]=i.useState(!0),[p,E]=i.useState(!1),[v,T]=i.useState(null),[xe,x]=i.useState(null),[ge,fe]=i.useState(!1),[b,o]=i.useState(null),[A,q]=i.useState(!1),[D,G]=i.useState(null),[w,O]=i.useState({totalScanned:0,matched:0,noMatch:0,potentialForgery:0}),[l,y]=i.useState(null),[S,_]=i.useState(!1),c=i.useRef(null),d=i.useRef(null),$=i.useRef(!1);i.useEffect(()=>(N?(async()=>{try{P(!0);const{data:s,error:a}=await ne.from("sessions").select("*").eq("id",N).single();if(a)throw a;K(s)}catch(s){console.error("Error fetching session:",s),o("Failed to load session details")}finally{P(!1)}})():P(!1),()=>{d.current&&(d.current.getTracks().forEach(s=>{s.stop()}),d.current=null),$.current=!1,E(!1)}),[N]),i.useEffect(()=>{(()=>{const s=navigator,a=!!(s.mediaDevices&&s.mediaDevices.getUserMedia),C=!!(s.mediaDevices?.getUserMedia||s.webkitGetUserMedia||s.mozGetUserMedia||s.msGetUserMedia),I=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),m=["localhost","127.0.0.1","192.168.254.100"].includes(window.location.hostname),h=window.isSecureContext;if(console.log("Basic media devices check:",{hasMediaDevices:a,hasGetUserMedia:C,isSecureContext:h,isMobile:I,isLocalNetwork:m,location:window.location.href}),I&&!h&&!m){G(!1);return}G(a||C)})()},[]);const W=async()=>{if(console.log("Starting camera..."),o(null),p||!c.current){console.log("Camera already active or video ref not available");return}q(!0);try{let t=[];try{t=await navigator.mediaDevices.enumerateDevices(),console.log("Available devices:",t);const r=t.filter(n=>n.kind==="videoinput");if(console.log("Video devices found:",r),r.length===0)throw new Error("No video input devices found")}catch(r){console.warn("Could not enumerate devices:",r)}console.log("Environment info:",{userAgent:navigator.userAgent,isSecureContext:window.isSecureContext,location:window.location.href,mediaDevices:!!navigator.mediaDevices,getUserMedia:!!navigator.mediaDevices?.getUserMedia});const s=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),a=["localhost","127.0.0.1","192.168.254.100"].includes(window.location.hostname),C=window.isSecureContext;if(s&&!C&&!a)throw new Error("Camera access requires HTTPS on mobile devices. Please use HTTPS or access from localhost.");s&&a&&console.log("Mobile device on local network detected, using legacy API if needed"),console.log("Requesting camera access...");let I;const m=navigator;let h=null;const te=async r=>{console.log("Trying constraints:",JSON.stringify(r));try{if(m.mediaDevices?.getUserMedia)return await m.mediaDevices.getUserMedia(r);if(m.webkitGetUserMedia)return await new Promise((n,g)=>m.webkitGetUserMedia(r,f=>n(f),f=>g(f)));if(m.mozGetUserMedia)return await new Promise((n,g)=>m.mozGetUserMedia(r,f=>n(f),f=>g(f)));throw new Error("No supported camera API found")}catch(n){throw console.error("Error in tryGetMedia:",n),n}},J=[{video:{facingMode:{exact:"environment"},width:{ideal:1920},height:{ideal:1080}},audio:!1},{video:{facingMode:{exact:"environment"}},audio:!1},{video:!0,audio:!1}];console.log("Trying constraint sets:",J);for(const r of J)try{if(h=await te(r),h){console.log("Successfully obtained stream with constraints:",r);break}}catch(n){console.warn(`Failed with constraints ${JSON.stringify(r)}:`,n)}if(!h)throw t.some(n=>n.kind==="videoinput")?new Error("Could not access camera. Please check browser permissions and ensure no other app is using the camera."):new Error("No camera found. Please ensure a camera is connected and not in use by another application.");if(console.log("Successfully got media stream"),c.current)return d.current&&(console.log("Stopping existing stream"),d.current.getTracks().forEach(r=>r.stop())),d.current=h,c.current.srcObject=h,new Promise(r=>{if(!c.current)return o("Video element not available"),r();const n=()=>{console.log("Video can play, starting..."),c.current?.play().then(()=>{console.log("Video playback started"),E(!0),T(null),x(null),r()}).catch(g=>{console.error("Error playing video:",g),o("Could not start the camera. Please try again."),U(),r()})};c.current.oncanplay=n,c.current.onerror=g=>{console.error("Video element error:",g),o("Error initializing video stream"),r()},c.current.readyState>=2&&n()})}catch(t){console.error("Camera error:",t),t instanceof Error?t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?o("Camera access was denied. Please check your browser settings and allow camera access."):t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?o("No camera found on this device."):t.name==="NotReadableError"?o("Camera is already in use by another application."):t.name==="TypeError"&&t.message.includes("navigator.mediaDevices")?o("Your browser does not support camera access or is not in a secure context (try using HTTPS or localhost)."):t.message.includes("HTTPS")?o(t.message):o(`Camera error: ${t.message}`):o("Failed to access camera. Please check your browser settings and try again.")}finally{q(!1)}},U=()=>{d.current&&(d.current.getTracks().forEach(t=>{t.stop()}),d.current=null),E(!1),$.current=!1},Z=async()=>{if(c.current){const t=document.createElement("canvas");t.width=c.current.videoWidth,t.height=c.current.videoHeight;const s=t.getContext("2d");if(s){s.drawImage(c.current,0,0,t.width,t.height);const a=t.toDataURL("image/png");T(a),U(),await ee(a)}}},ee=async t=>{_(!0),y(null),x(null);try{console.log("Starting AI signature verification...");const s=await le.verifySignatureFromDataURL(t,N?parseInt(N):void 0);console.log("AI verification result:",s),O(a=>({...a,totalScanned:a.totalScanned+1,matched:a.matched+(s.match?1:0),noMatch:a.noMatch+(s.match?0:1),potentialForgery:a.potentialForgery+(s.decision==="error"?1:0)})),s.success?(y({match:s.match,student:s.predicted_student,score:s.score,message:s.message}),s.match&&s.predicted_student?(x("success"),k.success(`Signature matched: ${s.predicted_student.firstname} ${s.predicted_student.surname} (${s.predicted_student.student_id})`)):(x("error"),k.warning("Signature not recognized. Please try again or mark attendance manually."))):(y({match:!1,score:0,message:s.error||"Verification failed"}),x("error"),k.error(s.error||"Signature verification failed"))}catch(s){console.error("Error during signature verification:",s),y({match:!1,score:0,message:"Verification error occurred"}),x("error"),k.error("Failed to verify signature. Please try again."),O(a=>({...a,totalScanned:a.totalScanned+1,potentialForgery:a.potentialForgery+1}))}finally{_(!1)}},se=()=>{T(null),y(null),x(null)};return Q?e.jsx(V,{children:e.jsx("div",{className:"p-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-medium text-education-navy",children:"Loading session details..."})]})})}):b||!u?e.jsx(V,{children:e.jsx("div",{className:"p-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-education-navy mb-4",children:b||"Session not found"}),e.jsx(j,{onClick:()=>Y("/take-attendance"),className:"mt-4",children:"Back to Sessions"})]})})}):e.jsx(V,{children:e.jsxs("div",{className:"px-6 py-4 space-y-6",children:[e.jsxs("div",{className:"text-left space-y-1",children:[e.jsx("h1",{className:"text-3xl font-bold text-education-navy",children:u.title}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:[u.program," • ",u.year," • ",u.section," • ",new Date(u.date).toLocaleDateString()," • ",u.time_in," - ",u.time_out]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(R,{className:"shadow-sm",children:[e.jsx(F,{className:"pb-2",children:e.jsxs(B,{className:"text-lg flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5 text-education-navy"}),"Signature Capture"]})}),e.jsxs(L,{className:"flex flex-col space-y-4 p-4",children:[e.jsx("div",{className:"w-full h-48 bg-muted/30 rounded-lg flex items-center justify-center border border-muted-foreground/20",children:e.jsxs("div",{className:"w-full h-full relative",children:[e.jsx("video",{ref:c,autoPlay:!0,playsInline:!0,muted:!0,className:`w-full h-full object-cover rounded-lg transition-opacity duration-300 ${p?"opacity-100":"opacity-0 absolute"}`}),b&&e.jsx("div",{className:"absolute inset-0 bg-red-50 rounded-lg flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(z,{className:"w-12 h-12 text-red-400 mx-auto mb-2"}),e.jsx("p",{className:"text-red-700 font-medium",children:"Camera Error"}),e.jsx("p",{className:"text-sm text-red-600 max-w-xs",children:b})]})}),v&&!p&&!b&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("img",{src:v,alt:"Captured Signature",className:"w-full h-full object-cover rounded-lg"})}),!p&&!v&&!b&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"w-16 h-16 bg-muted/50 rounded-full flex items-center justify-center mb-4",children:e.jsx(M,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("p",{className:"text-muted-foreground text-center",children:A?"Initializing camera...":"Camera not active"})]})]})}),D===!1&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm",children:[e.jsx("p",{className:"font-medium",children:"Camera access restricted"}),e.jsx("p",{className:"text-xs",children:!window.isSecureContext&&!["localhost","127.0.0.1","192.168.254.100"].includes(window.location.hostname)?"Camera access requires HTTPS on mobile devices. Please use HTTPS or access from localhost.":"No camera was detected on this device or camera access is not supported."})]}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&!window.isSecureContext&&!["localhost","127.0.0.1","192.168.254.100"].includes(window.location.hostname)&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(z,{className:"w-5 h-5 mt-0.5"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium",children:"HTTPS Required for Mobile Camera Access"}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("p",{children:"Mobile browsers require HTTPS to access the camera. To use camera features:"}),e.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-1",children:[e.jsx("li",{children:"Use HTTPS instead of HTTP"}),e.jsx("li",{children:"Access from localhost (localhost:3000)"}),e.jsx("li",{children:"Use a secure development server"})]})]})]})]})}),v&&l&&!S&&e.jsxs("div",{className:ie("mb-4 p-4 rounded-lg border",l.match?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"),children:[e.jsxs("div",{className:"flex items-center mb-2",children:[l.match?e.jsx(ue,{className:"w-5 h-5 mr-2"}):e.jsx(z,{className:"w-5 h-5 mr-2"}),e.jsx("span",{className:"font-medium",children:l.match?"Match Found!":"No Match"})]}),l.student&&e.jsxs("div",{className:"text-sm mb-2",children:[e.jsxs("strong",{children:[l.student.firstname," ",l.student.surname]}),e.jsx("br",{}),"Student ID: ",l.student.student_id]}),e.jsxs("div",{className:"text-sm",children:["Confidence: ",Math.round(l.score*100),"%"]}),l.message&&e.jsx("div",{className:"text-xs mt-2 opacity-80",children:l.message})]}),S&&e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-5 h-5 mr-2 animate-spin"}),e.jsx("span",{className:"font-medium",children:"Verifying signature..."})]}),e.jsx("div",{className:"text-sm mt-1 opacity-80",children:"Please wait while we process your signature"})]}),e.jsx("div",{className:"flex flex-col space-y-2",children:!p&&!v?e.jsx(j,{onClick:W,disabled:A||D===!1,className:"w-full bg-teal-300 text-white hover:bg-teal-200 hover:text-teal-900 py-2 h-auto text-base transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",size:"lg",children:A?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-5 h-5 mr-2 animate-spin"}),e.jsx("span",{children:"Requesting Access..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-5 h-5 mr-2 text-white"}),e.jsx("span",{className:"text-white",children:D===!1?"Camera Not Available":"Start Camera"})]})}):p?e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(j,{onClick:Z,disabled:S,className:"flex-1 bg-teal-300 text-white hover:bg-teal-200 hover:text-teal-900 py-2 h-auto text-base transition-all duration-200 disabled:opacity-50",size:"lg",children:[e.jsx(M,{className:"w-5 h-5 mr-2 text-white"}),e.jsx("span",{className:"text-white",children:"Capture Signature"})]}),e.jsxs(j,{onClick:U,variant:"outline",className:"flex-shrink-0 px-3 sm:px-4 py-2 h-auto text-base hover:bg-transparent hover:text-inherit active:bg-transparent focus:bg-transparent focus-visible:ring-0 focus-visible:ring-offset-0",size:"lg",children:[e.jsxs("div",{className:"relative w-5 h-5 mr-2",children:[e.jsx(de,{className:"w-4 h-4 text-red-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"}),e.jsx("div",{className:"w-3 h-3 bg-red-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"})]}),e.jsx("span",{className:"hidden sm:inline",children:"Stop"})]})]}):v?e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(j,{onClick:se,variant:"outline",className:"flex-1 py-2 h-auto text-base",size:"lg",disabled:S,children:[e.jsx(me,{className:"w-5 h-5 mr-2"}),"Retake"]}),e.jsxs(j,{onClick:W,className:"flex-1 bg-teal-300 text-white hover:bg-teal-200 hover:text-teal-900 py-2 h-auto text-base transition-all duration-200",size:"lg",disabled:S,children:[e.jsx(M,{className:"w-5 h-5 mr-2 text-white"}),e.jsx("span",{className:"text-white",children:"New Capture"})]})]}):null})]})]}),e.jsxs(R,{className:"shadow-sm",children:[e.jsx(F,{className:"p-4 pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(B,{className:"text-lg",children:"Attendance Log"}),e.jsxs(ce,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:[w.matched," captured"]})]})}),e.jsx(L,{className:"p-0",children:e.jsxs("div",{className:"w-full h-48 bg-muted/10 flex flex-col items-center justify-center",children:[e.jsx(oe,{className:"w-12 h-12 text-muted-300 mb-2"}),e.jsx("p",{className:"text-muted-500",children:"No signatures captured yet"})]})})]})]}),e.jsxs(R,{className:"shadow-sm mt-6",children:[e.jsx(F,{className:"pb-2",children:e.jsx(B,{className:"text-lg",children:"Session Statistics"})}),e.jsx(L,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-muted/30 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-center",children:w.totalScanned}),e.jsx("p",{className:"text-center text-muted-foreground text-sm mt-1",children:"Total Scanned"})]}),e.jsxs("div",{className:"bg-muted/30 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-center text-green-600",children:w.matched}),e.jsx("p",{className:"text-center text-muted-foreground text-sm mt-1",children:"Matched"})]}),e.jsxs("div",{className:"bg-muted/30 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-center text-red-600",children:w.noMatch}),e.jsx("p",{className:"text-center text-muted-foreground text-sm mt-1",children:"No Match"})]}),e.jsxs("div",{className:"bg-muted/30 p-4 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-center text-amber-500",children:w.potentialForgery}),e.jsx("p",{className:"text-center text-muted-foreground text-sm mt-1",children:"Potential Forgery"})]})]})})]})]})})};export{Me as default};
