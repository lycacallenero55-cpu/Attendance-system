import{s as i}from"./index-Dm7atRpY.js";const V=async l=>{const{data:e,error:m}=await i.from("sessions").insert([l]).select().single();if(m)throw m;return e},Y=async(l,e)=>{const{data:m,error:s}=await i.from("sessions").update(e).eq("id",l).select().single();if(s)throw s;return m},k=async l=>{const{error:e}=await i.from("sessions").delete().eq("id",l);if(e)throw e},x=async l=>{if(!l)throw new Error("Session ID is required");const{data:e,error:m}=await i.from("sessions").select("*").eq("id",l).single();if(m)throw m;if(!e)throw new Error("Session not found");console.log("Full session object:",JSON.stringify(e,null,2));const s=r=>{if(!r)return!0;const t=r.toLowerCase().trim();return t.includes("all")||t===""||t==="all programs"||t==="all year levels"||t==="all sections"},p=async r=>{const t=[];let g=0;const f=1e3;for(;;){const{data:a,error:c}=await r.range(g,g+f-1);if(c)throw c;if(!a||a.length===0||(t.push(...a),a.length<f))break;g+=f}return t};console.log("Session object:",JSON.stringify(e,null,2));const o=e.section||e.session_section;console.log("Using filters:",{program:e.program,year:e.year,section:o});let u=i.from("students").select("*",{count:"exact",head:!0});if(e.program&&!s(e.program)&&(u=u.eq("program",e.program.trim())),e.year&&!s(e.year)){let r=e.year.trim();r.endsWith(" Year")&&(r=r.replace(" Year","")),u=u.eq("year",r)}o&&!s(o)&&(u=u.eq("section",o.trim()));const{count:b,error:w}=await u;if(w)return console.error("Error counting students:",w),{session:e,students:[],count:0};console.log("Total matching students:",b);let n=[];try{console.log("Fetching students with filters:",{program:e.program,year:e.year,section:o});let r=i.from("students").select("*").order("id");if(console.log("Base query created"),e.program&&!s(e.program)){const t=e.program.trim();console.log("Applying program filter:",t),r=r.eq("program",t)}if(e.year&&!s(e.year)){let t=e.year.trim();t.endsWith(" Year")&&(t=t.replace(" Year","")),console.log("Applying year filter:",t),r=r.eq("year",t)}if(o&&!s(o)){const t=o.trim();console.log("Applying section filter:",t),r=r.eq("section",t)}if(console.log("Executing query with filters and pagination"),n=await p(r),console.log(`Found ${n.length} students with exact filters`),n.length>0&&console.log("Sample students:",n.slice(0,3).map(t=>({id:t.id,name:`${t.firstname} ${t.surname}`,program:t.program,year:t.year,section:t.section}))),n.length===0&&o&&!s(o)){console.log("Trying alternative section formats...");const t=o.trim().split(" ").pop()||"";console.log("Extracted section number/identifier:",t);const g=[o.trim(),t,o.trim().replace(/\s+/g," "),o.trim().toUpperCase(),o.trim().toLowerCase(),o.trim().replace(/\s/g,""),t.replace(/\s/g,"")],f=[...new Set(g)];console.log("Trying section formats:",f);for(const a of f){if(!a)continue;console.log(`Trying section format: "${a}"`);let c=i.from("students").select("*");if(e.program&&!s(e.program)&&(c=c.eq("program",e.program.trim())),e.year&&!s(e.year)){let d=e.year.trim();d.endsWith(" Year")&&(d=d.replace(" Year","")),c=c.eq("year",d)}const y=await p(c.eq("section",a));if(y?.length){console.log(`Found ${y.length} students with exact section: "${a}"`),n=[...y];break}const h=await p(c.ilike("section",`%${a}%`));if(h?.length){console.log(`Found ${h.length} students with partial section: "${a}"`),n=[...h];break}}}if(n.length===0&&e.program&&e.year&&!s(e.program)&&!s(e.year)){console.log("Falling back to program and year only");let t=e.year.trim();t.endsWith(" Year")&&(t=t.replace(" Year","")),n=[...await p(i.from("students").select("*").eq("program",e.program.trim()).eq("year",t))]}n.length===0&&e.program&&!s(e.program)&&(console.log("Falling back to program only"),n=[...await p(i.from("students").select("*").eq("program",e.program.trim()))])}catch(r){throw console.error("Error fetching students:",r),r}const _=n||[];if(!e)throw new Error("Session not found");const{data:$,error:q}=await i.from("attendance").select("*").eq("session_id",l);if(q)throw q;const S=_.map(r=>{const t=$?.find(g=>g.student_id===r.id)||null;return{...r,full_name:`${r.firstname} ${r.surname}`,status:t?.status||null,time_in:t?.time_in||null,time_out:t?.time_out||null}});return{session:{id:e.id,title:e.title,date:e.date,time_in:e.time_in||null,time_out:e.time_out||null,program:e.program,year:e.year,section:e.section,description:e.description||"",type:e.type||"class"},students:S,count:S.length}};export{V as c,k as d,x as f,Y as u};
